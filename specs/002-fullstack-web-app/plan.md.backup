# Implementation Plan: Full-Stack Web Todo Application

**Branch**: `002-fullstack-web-app` | **Date**: 2025-12-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-fullstack-web-app/spec.md`
**Research**: Authentication research complete - Better Auth + JWT + JWKS pattern

## Summary

Transform the Phase I in-memory console Todo app into a modern, multi-user, authenticated full-stack web application with persistent storage using:
- **Frontend**: Next.js 16+ App Router with Better Auth for authentication
- **Backend**: FastAPI with async SQLAlchemy and JWT verification via JWKS
- **Database**: PostgreSQL with user accounts and task data
- **Auth Pattern**: Better Auth (Next.js) issues JWTs signed with EdDSA/Ed25519; FastAPI verifies via JWKS endpoint without shared secrets

## Technical Context

**Language/Version**: Python 3.13+ (FastAPI), TypeScript 5.x (Next.js 16+)
**Primary Dependencies**: FastAPI 0.100+, SQLAlchemy 2.0 async, Better Auth 1.4+, python-jose, httpx
**Storage**: PostgreSQL 14+ with SQLAlchemy 2.0 async (using drizzle-orm or SQLAlchemy core - TBD)
**Testing**: pytest (backend), Jest/Vitest (frontend)
**Target Platform**: Web browser (Chrome, Firefox, Safari, Edge - last 2 major versions)
**Project Type**: Full-stack web application (monorepo: frontend/, backend/)
**Performance Goals**: <500ms p95 for API responses, <3s page load on broadband
**Constraints**: JWT expiry 1 hour, user isolation enforced at API layer, XSS protection via CSP
**Scale/Scope**: Single deployment, unlimited users, data isolation per user

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Hackathon Constitution Compliance

- [x] **Spec-First Mindset**: Complete specification exists in `/specs/002-fullstack-web-app/spec.md`
- [x] **Zero Manual Coding**: Plan demonstrates code will be generated by Claude Code (≥95% target)
- [x] **Progressive Evolution**: Builds on Phase I console app architecture (domain/repository/service/ui layers)
- [x] **Reusability and Intelligence**: Leverages Better Auth for auth UI, python-jose for JWT verification
- [x] **Production-Grade Quality**: Includes error handling, security (JWT verification, user isolation), observability
- [x] **Specification Quality**: Spec is technology-agnostic, focuses on WHAT/WHY, has acceptance criteria
- [x] **Code Generation Process**: Plan shows iterative refinement path for Claude Code
- [x] **Project Structure**: Adheres to monorepo layout (frontend/, backend/, CLAUDE.md, /specs/)
- [x] **Testing**: Test specifications defined before implementation; tests generated via spec process
- [x] **Documentation**: README and CLAUDE.md update plan included
- [x] **Security**: Authentication/authorization/data isolation addressed (Better Auth + JWT + JWKS)
- [x] **Deployment**: Docker/K8s reserved for Phase IV
- [x] **Technology Stack**: Uses approved stack (Next.js, FastAPI, PostgreSQL, Better Auth)
- [x] **Git History**: Commit strategy shows spec → code → refinement cycle

## Project Structure

### Documentation (this feature)

```text
specs/002-fullstack-web-app/
├── plan.md                    # This file
├── research-authentication.md # Phase 0 research output
├── data-model.md              # Pending (Phase 1)
├── quickstart.md              # Pending (Phase 1)
├── contracts/                 # Pending (Phase 1)
│   └── README.md
└── tasks.md                   # Pending (/sp.tasks command)
```

### Source Code (repository root)

```text
todo/                          # Monorepo root (Phase I project)
├── CLAUDE.md                  # Updated with Phase II guidance
├── README.md                  # Updated with Phase II overview
├── backend/                   # FastAPI application
│   ├── src/
│   │   ├── __init__.py
│   │   ├── main.py            # Application entry point
│   │   ├── api/               # API routes (router-based)
│   │   │   ├── __init__.py
│   │   │   ├── tasks.py       # Task CRUD endpoints
│   │   │   └── health.py      # Health check
│   │   ├── auth/              # Authentication layer
│   │   │   ├── __init__.py
│   │   │   └── jwt_verify.py  # JWT verification via JWKS
│   │   ├── models/            # Data models (SQLAlchemy)
│   │   │   ├── __init__.py
│   │   │   ├── user.py        # User model
│   │   │   └── task.py        # Task model
│   │   ├── repository/        # Data access layer
│   │   │   ├── __init__.py
│   │   │   ├── user_repository.py
│   │   │   └── task_repository.py
│   │   ├── service/           # Business logic layer
│   │   │   ├── __init__.py
│   │   │   ├── user_service.py
│   │   │   └── task_service.py
│   │   └── schemas/           # Pydantic schemas
│   │       ├── __init__.py
│   │       ├── task.py        # Task schemas
│   │       └── auth.py        # Auth schemas
│   ├── tests/
│   │   ├── __init__.py
│   │   ├── conftest.py
│   │   ├── unit/
│   │   ├── integration/
│   │   └── contract/
│   ├── .env                   # Environment variables
│   ├── requirements.txt       # Python dependencies
│   └── alembic/               # Database migrations
│       ├── env.py
│       └── versions/
├── frontend/                  # Next.js application
│   ├── public/
│   ├── src/
│   │   ├── app/               # Next.js App Router
│   │   │   ├── layout.tsx
│   │   │   ├── page.tsx       # Landing page
│   │   │   ├── globals.css
│   │   │   ├── sign-in/       # Sign-in page
│   │   │   │   └── page.tsx
│   │   │   ├── sign-up/       # Sign-up page
│   │   │   │   └── page.tsx
│   │   │   └── dashboard/     # Protected dashboard
│   │   │       ├── layout.tsx
│   │   │       └── page.tsx
│   │   ├── components/        # React components
│   │   │   ├── ui/            # Base UI components
│   │   │   ├── auth/          # Auth components
│   │   │   └── tasks/         # Task components
│   │   ├── lib/               # Utilities
│   │   │   ├── auth.ts        # Better Auth configuration
│   │   │   └── api.ts         # API client with JWT
│   │   ├── hooks/             # Custom React hooks
│   │   │   └── useAuth.ts
│   │   ├── context/           # React Context providers
│   │   │   └── AuthContext.tsx
│   │   └── types/             # TypeScript types
│   ├── tests/
│   │   └── ...
│   ├── .env.local             # Environment variables
│   ├── package.json
│   └── next.config.ts
└── docker-compose.yml         # Local development (Phase III)
```

**Structure Decision**: Monorepo with `backend/` (FastAPI) and `frontend/` (Next.js) directories. Authentication handled by Better Auth in Next.js; FastAPI provides API-only backend with JWT verification via JWKS. User isolation enforced at API layer using `user_id` from verified JWT.

## Architecture Overview

### System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        User's Browser                           │
│  ┌─────────────┐    ┌─────────────────────────────────────┐   │
│  │ Next.js App │    │ Better Auth (Next.js /api/auth)     │   │
│  │  Frontend   │◄──►│ - Signup/Signin UI                  │   │
│  │             │    │ - Session Management (httpOnly)     │   │
│  │             │    │ - JWT Token Issuance (EdDSA)        │   │
│  └──────┬──────┘    └──────┬──────────────────────────────┘   │
│         │                   │                                  │
│         │ 1. JWT Request    │ 2. Session Cookie               │
│         │ (authClient.      │ (httpOnly, 7-14 days)          │
│         │  token())         │                                 │
│         └──────────────────►│                                 │
│                            │                                  │
┌────────────────────────────│──────────────────────────────────┤
│                            │                                  │
│  3. API Request + JWT      │                                  │
│  (Bearer token in header)  │                                  │
│  ─────────────────────────────────────────────────────────►  │
│                            │                                  │
│                            │    4. Fetch JWKS                 │
│                            │    (cached 1 hour)               │
│                            │◄─────────────────────────────────│
│                            │                                  │
│                            │    5. Verify JWT (EdDSA)         │
│                            │    - Signature check             │
│                            │    - Issuer validation           │
│                            │    - Audience validation         │
│                            │    - Expiry check                │
│                            │                                  │
│                            │    6. Extract user_id from JWT   │
│                            │                                  │
│                            │    7. User Isolation Query       │
│                            │    (WHERE user_id = ?)           │
│                            │                                  │
│  8. API Response           │                                  │
│  ◄──────────────────────────────────────────────────────────  │
│                            │                                  │
└────────────────────────────│──────────────────────────────────┘
                             │
                             ▼
                   ┌─────────────────────┐
                   │   PostgreSQL DB     │
                   │ - users table       │
                   │ - tasks table       │
                   └─────────────────────┘
```

### Authentication Flow

1. **Signup/Signin**: User authenticates via Better Auth in Next.js (email/password)
2. **Session Creation**: Better Auth creates session stored in httpOnly cookie (7-14 days)
3. **JWT Request**: Frontend calls `authClient.token()` to get JWT access token
4. **JWT Structure**: JWT signed with EdDSA/Ed25519 (asymmetric), contains:
   - `sub`: User ID
   - `iss`: Issuer (Next.js base URL)
   - `aud`: Audience (FastAPI URL)
   - `exp`: Expiration (1 hour)
   - Custom claims (email)
5. **API Request**: Frontend includes JWT in `Authorization: Bearer <token>` header
6. **JWKS Fetch**: FastAPI fetches public keys from Better Auth `/api/auth/jwks` (cached)
7. **JWT Verification**: FastAPI verifies JWT signature, issuer, audience, expiry
8. **User Isolation**: API operations filter by `user_id` from verified JWT payload

### Data Isolation

- Every Task record includes `user_id` foreign key
- All API endpoints use `Depends(get_current_user)` to extract `user_id`
- Repository layer enforces `WHERE user_id = <current_user_id>`
- Direct database queries by other user IDs are rejected at API layer

## Key Decisions

### Auth Strategy: Better Auth + JWT + JWKS

| Decision | Rationale |
|----------|-----------|
| Better Auth | Modern successor to NextAuth.js, excellent TypeScript support, built-in JWT plugin |
| JWT over Sessions | Stateless auth enables horizontal scaling; no shared session database needed |
| EdDSA/Ed25519 | Asymmetric signing; private key stays in Next.js, public key in JWKS |
| JWKS Verification | No shared secrets between services; standards-based (OAuth 2.0); supports key rotation |
| 1-hour JWT expiry | Balances security (limited exposure) with UX (not too frequent refreshes) |

**ADR Reference**: See `/history/adr/` for detailed authentication ADR documentation.

### Database: PostgreSQL + Async SQLAlchemy

| Decision | Rationale |
|----------|-----------|
| PostgreSQL | Robust, production-grade, excellent JSON support, proper user isolation via schemas |
| SQLAlchemy 2.0 async | Type-safe, ORM with async support, migrations via Alembic |
| User/Task tables | Separate tables with foreign key relationship; user_id on all task queries |

### API Framework: FastAPI

| Decision | Rationale |
|----------|-----------|
| FastAPI | High-performance, async native, automatic OpenAPI docs, type-safe dependency injection |
| JWT Verification | python-jose library provides excellent EdDSA/JWKS support |
| Dependency Injection | `Depends()` for auth middleware; clean separation of concerns |

## API Contracts

### Authentication Endpoints (Better Auth - Next.js)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/auth/sign-up` | POST | Create new user account |
| `/api/auth/sign-in` | POST | Authenticate existing user |
| `/api/auth/sign-out` | POST | End authenticated session |
| `/api/auth/get-session` | GET | Retrieve current session |
| `/api/auth/token` | GET | Get JWT access token |
| `/api/auth/jwks` | GET | JSON Web Key Set (public keys) |

### Task API Endpoints (FastAPI)

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/tasks` | GET | JWT | List all tasks for authenticated user |
| `/api/tasks` | POST | JWT | Create new task |
| `/api/tasks/{task_id}` | GET | JWT | Get specific task details |
| `/api/tasks/{task_id}` | PUT | JWT | Update task title |
| `/api/tasks/{task_id}` | DELETE | JWT | Delete task |
| `/api/tasks/{task_id}/toggle` | PATCH | JWT | Toggle completion status |

### Response Format

```json
// Success Response (200/201)
{
  "data": { /* response payload */ },
  "meta": { "user_id": "uuid" }
}

// Error Response (4xx/5xx)
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message"
  }
}

// Validation Error (422)
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input",
    "details": [ /* field errors */ ]
  }
}
```

## Implementation Phases

### Phase 1: Project Setup & Database

1. Initialize FastAPI backend with project structure
2. Set up PostgreSQL connection with SQLAlchemy 2.0 async
3. Create User and Task models with proper relationships
4. Set up Alembic for database migrations
5. Initialize Next.js frontend with TypeScript
6. Configure Tailwind CSS and project structure

### Phase 2: Better Auth Setup (Frontend)

1. Install Better Auth with JWT plugin
2. Configure database adapter (PostgreSQL via better-sqlite3 or Drizzle)
3. Create auth configuration (`lib/auth.ts`)
4. Implement signup/signin UI pages
5. Test JWT token issuance
6. Verify JWKS endpoint accessibility

### Phase 3: FastAPI JWT Verification

1. Install python-jose and httpx
2. Create JWT verification module with JWKS fetching
3. Implement `verify_jwt_token` dependency
4. Create `get_current_user` dependency
5. Add error handling for invalid/expired tokens
6. Test verification with real tokens from Better Auth

### Phase 4: Task API with User Isolation

1. Create task Pydantic schemas
2. Implement task repository with user filtering
3. Create task service with business logic
4. Build API endpoints with auth dependencies
5. Enforce user isolation on all operations
6. Add comprehensive error handling

### Phase 5: Frontend Integration

1. Create API client with JWT injection
2. Implement AuthContext for in-memory token storage
3. Build dashboard page with task list
4. Create task creation form
5. Implement task editing and deletion
6. Add toggle completion functionality
7. Handle authentication errors and redirects

### Phase 6: Testing & Polish

1. Write backend unit tests (models, services)
2. Write integration tests (API endpoints with auth)
3. Write frontend component tests
4. Test multi-user scenarios (user isolation)
5. Responsive design testing
6. Performance testing

## Environment Variables

### Frontend (.env.local)

```bash
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:8000
DATABASE_URL=postgresql://user:password@localhost:5432/todo_db
BETTER_AUTH_SECRET=<generate-32+-char-random-string>
```

### Backend (.env)

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/todo_db
BETTER_AUTH_JWKS_URL=http://localhost:3000/api/auth/jwks
BETTER_AUTH_ISSUER=http://localhost:3000
API_AUDIENCE=http://localhost:8000
```

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Asymmetric auth (JWKS) | Security - no shared secrets between services | HS256 shared secret - violates separation of concerns, no key rotation |
| Two separate processes | Better Auth is Next.js native; FastAPI for API | Single process - loses framework strengths, more complex |

## Next Steps

1. **Review and approve** this plan
2. **Create ADR** for authentication architecture (Better Auth + JWT + JWKS)
3. **Generate tasks.md** via `/sp.tasks` command with detailed implementation tasks
4. **Begin Phase 1**: Project setup and database implementation

## References

- **Spec**: `/specs/002-fullstack-web-app/spec.md`
- **Research**: `/specs/002-fullstack-web-app/research-authentication.md`
- **Phase I**: `/specs/001-todo-basic-console/`
